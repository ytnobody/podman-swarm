## 📝 CLIツール「podman-swarm」要件定義書 (最終版)

### 1. 概要とアーキテクチャ

| 項目 | 詳細 |
| :--- | :--- |
| **システム名** | **podman-swarm** |
| **CLIバイナリ名** | `podman-swarm` |
| **目的** | SSHを唯一の通信チャネルとし、複数のリモートホスト上のPodmanコンテナ群を中央のCLIから一元的に管理・操作する。 |
| **アーキテクチャ** | **エージェントレス**。Podman-swarm (Go CLI) が、リモートホストの`sshd`を経由し、**ネイティブな `podman` コマンド**を直接実行する。 |
| **ターゲットコンテナ** | Podmanコンテナ |

---

### 2. 機能要件 (Functional Requirements)

#### 2.1. インベントリ管理機能 (設定ファイル)

Podman-swarmは、管理対象ホストの情報を設定ファイル（推奨：YAML形式）で保持します。

| ID | 機能 | 詳細 |
| :--- | :--- | :--- |
| **F-01** | **設定ファイル読み込み** | YAML形式の設定ファイル（デフォルト: `~/.config/podman-swarm/hosts.yaml`などを想定）からホスト情報を読み込むこと。 |
| **F-02** | **接続情報定義** | 各ホストに対し、**ホスト名/IPアドレス**、**SSHユーザー名**、**SSH秘密鍵のパス**を設定できること。 |
| **F-03** | **グループ化** | ホストを論理的なグループ（例: `web`, `db`）に分けて定義し、グループ単位でコマンドを実行できること。 |

#### 2.2. 情報収集（参照）機能

リモートで `podman` コマンドを実行し、結果を集約・整形して表示します。

| ID | コマンド名 | 機能 | 詳細 |
| :--- | :--- | :--- | :--- |
| **F-10** | `podman-swarm status` | **全ホスト稼働状況一覧表示** | 全ホストに対し並行処理でSSH接続を試行し、接続可否、および `podman info` の実行可否を確認して、ステータスをテーブル表示する。 |
| **F-11** | `podman-swarm ps` | **全コンテナ情報一覧表示** | 全ホストに対し `podman ps -a --format json` を実行し、結果をManager側で集約。**ホスト名を含む**テーブル形式で一覧表示する。 |
| **F-12** | `podman-swarm inspect <host> <cid/name>` | **特定コンテナ詳細表示** | 指定ホスト上で `podman inspect` を実行し、結果をJSON形式などで表示する。 |

#### 2.3. 指令（操作）機能

リモートホスト上のネイティブな `podman` コマンドを、グループまたは単一ホストに実行します。

| ID | コマンド名 | 機能 | 詳細 |
| :--- | :--- | :--- | :--- |
| **F-20** | `podman-swarm run <host/group> <image> ...` | **コンテナの作成と起動** | リモートで `podman run` コマンドを実行する。`podman-swarm`は後続の引数（`-d`, `--name`, `-p`など）を透過的にリモートに渡すこと。 |
| **F-21** | `podman-swarm stop <host/group> <cid/name>` | **コンテナの停止** | リモートで `podman stop` を実行する。 |
| **F-22** | `podman-swarm rm <host/group> <cid/name>` | **コンテナの削除** | リモートで `podman rm` を実行する。 |
| **F-23** | `podman-swarm exec <host> <cid/name> <cmd>` | **コンテナ内でのコマンド実行** | リモートで `podman exec` を実行し、結果をManager側に返すこと。 |

---

### 3. 非機能要件 (Non-Functional Requirements)

| ID | 要件 | 詳細 |
| :--- | :--- | :--- |
| **N-01** | **開発言語** | **Go (Golang)**。単一の静的バイナリとしてビルドされること。 |
| **N-02** | **通信プロトコル** | すべての通信は**SSH (Port 22)** のみを介して行われること。他のポートを外部に公開しないこと。 |
| **N-03** | **認証方式** | SSHの**公開鍵認証**のみをサポートすること。 |
| **N-04** | **並行処理** | 複数ホストへのSSH接続およびコマンド実行は、**ゴルーチン**を利用して並行処理され、処理速度を最適化すること。 |
| **N-05** | **依存関係** | 実行環境にGoランタイムやその他の言語（Python, Rubyなど）の依存関係を持たないこと。 |
| **N-06** | **エラー処理** | SSH接続失敗、コマンド実行エラー、JSONパースエラーなどの発生源と詳細を明確にユーザーに通知すること。 |
| **N-07** | **出力形式** | `ps`などの情報表示系コマンドの出力は、CLIで視認しやすい**整形されたテーブル形式**とし、必要に応じてJSON出力オプション（例: `--json`）も提供すること。 |

---

### 4. 推奨技術スタック

| 要素 | 技術名 | 採用理由 |
| :--- | :--- | :--- |
| **言語** | Go (Golang) | 軽量バイナリ、並行処理、SSHライブラリの安定性。 |
| **SSHクライアント** | `golang.org/x/crypto/ssh` | Goの標準的なSSH機能。 |
| **CLIフレームワーク** | `github.com/spf13/cobra` | コマンドの階層化と引数処理の標準化。 |
| **設定/インベントリ** | `github.com/spf13/viper` | YAML形式の設定ファイル読み込み。 |
| **テーブル表示** | `github.com/olekukonko/tablewriter`など | CLI出力を視認性高く整形する。 |